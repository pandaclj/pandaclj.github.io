<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Mysql索引之坑</title>
      <link href="/2019/07/mysql-suo-yin-zhi-keng/"/>
      <url>/2019/07/mysql-suo-yin-zhi-keng/</url>
      
        <content type="html"><![CDATA[<h1 id="Mysql索引之坑"><a href="#Mysql索引之坑" class="headerlink" title="Mysql索引之坑"></a>Mysql索引之坑</h1><p><img src="/2019/07/mysql-suo-yin-zhi-keng/15620576632595.jpg" alt></p><p>查看mysql慢日志，发现命中条数蛮多，于是找下是否是索引的问题</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ol><li>查看表结构<br><code>show create table multiple_menu_element;</code></li></ol><pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>multiple_menu_element<span class="token punctuation">`</span> <span class="token punctuation">(</span>        <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>entity_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'实体id'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>multiple_menu_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'多菜单主键'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>menu_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'菜品主键'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>use_default_price_switch<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否使用默认价格:0.否 1.是'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>price<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'价格'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>member_price<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'会员价'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>ext<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'json格式扩展属性，目前只有规格价格，格式如下： {"specPrice":{"123":123,"345":123}'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>is_valid<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否有效:0.失效 1有效'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>op_time<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>        <span class="token punctuation">`</span>last_ver<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'版本号'</span><span class="token punctuation">,</span>        <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_eid_menuId<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>entity_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>menu_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_eid_multipleMenuId_menuId<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>entity_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>multiple_menu_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>menu_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_eid_opTime<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>entity_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>op_time<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci ROW_FORMAT<span class="token operator">=</span>DYNAMIC <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'菜单商品关联表'</span><span class="token punctuation">;</span></code></pre><p>2.也可以查看表上的索引 <code>show index from multiple_menu_element;</code><br><img src="/2019/07/mysql-suo-yin-zhi-keng/15620578849311.jpg" alt></p><p>看索引感觉没问题，难道是自己对索引的理解一直有问题。于是explain下</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#根据菜谱id查</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> multiple_menu_element  <span class="token keyword">WHERE</span> entity_id <span class="token operator">=</span> <span class="token string">'00240950'</span>  <span class="token operator">and</span> multiple_menu_id <span class="token operator">=</span> <span class="token string">'00240950647f61f40164ac3e0cf91717'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#根据菜id查</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">select</span>  <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> multiple_menu_element  <span class="token keyword">WHERE</span> entity_id <span class="token operator">=</span> <span class="token string">'00240950'</span>  <span class="token operator">and</span> menu_id <span class="token operator">=</span> <span class="token string">'00240950647f61f40164ac3e0cf91717'</span><span class="token punctuation">;</span></code></pre><p><img src="/2019/07/mysql-suo-yin-zhi-keng/15620583481702.jpg" alt><br>以上为第一条的执行结果，与预期的有出入</p><p>找dba查找原因：发现部分实例上执行是正确的，部分是有问题的，怀疑是索引的统计信息有问题。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>索引统计有误从而误导了mysql优化器的索引选择</p><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>1.索引优化，利用<code>force index</code>语法强制使用某个索引，不要让mysql优化器去选择</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>multiple_menu_id<span class="token punctuation">)</span> <span class="token keyword">from</span> multiple_menu_element  <span class="token keyword">force</span> <span class="token keyword">index</span><span class="token punctuation">(</span>idx_eid_multipleMenuId_menuId<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> entity_id <span class="token operator">=</span> <span class="token string">'00240950'</span>  <span class="token operator">and</span> multiple_menu_id <span class="token operator">=</span> <span class="token string">'00240950647f61f40164ac3e0cf91717'</span> <span class="token punctuation">;</span></code></pre><p>2.索引统计信息重建</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">analyze</span> <span class="token keyword">table</span> multiple_menu_element<span class="token punctuation">;</span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://yq.aliyun.com/articles/502786" target="_blank" rel="noopener">show index from 及analyze table 详解</a></li><li><a href="https://www.cnblogs.com/yycc/p/7338894.html" target="_blank" rel="noopener">mysql explain用法和结果的含义</a></li><li><a href="https://www.cnblogs.com/Alight/p/3906086.html" target="_blank" rel="noopener">MYSQL 分析表、检查表和优化表</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 踩坑之路 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
